# AI恋爱游戏 - 阿里云百炼 Qwen 集成使用指南

## 快速开始

### 第一步：获取 API Key

1. 访问 [阿里云百炼平台](https://dashscope.console.aliyun.com/)
2. 登录/注册阿里云账号
3. 在控制台点击"API-KEY管理"
4. 创建新的 API Key 并保存（格式：sk-xxxxxxxxxxxxx）

### 第二步：配置云函数

在 HBuilderX 中：

1. 右键点击 `uniCloud-aliyun/cloudfunctions/chat-engine`
2. 选择"云函数配置" -> "云端配置"
3. 添加环境变量：
   ```
   DASHSCOPE_API_KEY=sk-your-api-key-here
   AI_MODEL=qwen-plus
   ```
4. 点击"保存"
5. 右键云函数，选择"上传部署"

### 第三步：导入角色数据

1. 打开 uniCloud Web控制台
2. 选择数据库 -> `characters` 集合
3. 参考 `characters_sample_data.md` 导入示例角色
4. 确保至少导入一个角色用于测试

### 第四步：测试对话

可以通过以下方式测试：

#### 方式 1：使用云函数测试（推荐）

1. 右键 `chat-engine` 云函数
2. 选择"运行-云端运行"
3. 输入测试参数：

```json
{
  "characterId": "F01",
  "userMessage": "你好呀！",
  "gameState": {
    "stageIndex": 0,
    "favorability": 0,
    "trust": 0,
    "intimacy": 0,
    "boredom": 0,
    "freshness": 100,
    "mood": "normal",
    "daysTogether": 0
  },
  "recentMessages": []
}
```

4. 查看返回结果

#### 方式 2：在前端页面测试

1. 运行项目到微信开发者工具或浏览器
2. 选择角色进入聊天界面
3. 发送消息测试

## 核心功能说明

### 1. 智能性格控制

系统会自动从角色的 `personality` 字段提取关键词，并生成对应的性格表现：

```javascript
// 示例：温柔学姐
personality: "温柔体贴，善解人意，总是能察觉到别人的情绪变化"
// 系统提取关键词：['温柔', '成熟']
// 生成指导：用词温和，多用"呢"、"哦"、"～"等柔和语气词
```

**支持的性格类型：**
- 温柔型：温暖体贴，用词柔和
- 高冷型：冷淡疏离，话少简洁
- 开朗型：活泼阳光，积极向上
- 害羞型：内向腼腆，容易脸红
- 成熟型：稳重理性，说话得体
- 可爱型：软萌俏皮，用叠词
- 霸道型：强势主导，直接表达
- 文艺型：浪漫优雅，诗意表达
- 幽默型：风趣搞笑，轻松氛围
- 知性型：智慧理性，逻辑清晰

### 2. 对话记忆系统

系统会自动管理对话历史：

- **短期记忆**：保留最近 10 轮完整对话
- **上下文理解**：AI 能记住之前说过的话
- **记忆摘要**：长对话会自动生成摘要

```javascript
// 对话示例
用户: "我今天去了图书馆"
AI: "哦？看了什么书呀？"
用户: "看了一本小说"
AI: "你刚才说去了图书馆看小说，是什么类型的呀？" // 记住了之前的内容
```

### 3. 游戏数值系统

#### 关系阶段（14个）
```
0. 陌生人 -> 1. 认识 -> 2. 熟悉 -> 3. 朋友 
-> 4. 暧昧 -> 5. 表白 -> 6. 恋人 -> 7. 求婚 
-> 8. 新婚 -> 9. 育儿 -> 10. 10年婚姻 
-> 11. 20年婚姻 -> 12. 30年婚姻 -> 13. 白头偕老
```

#### 五维数值
- **好感度 (0-100)**：决定关系进展
- **信任度 (0-100)**：影响AI开放程度
- **亲密度 (0-100)**：影响亲密互动
- **无聊度 (0-100)**：过高会导致关系降温
- **新鲜感 (0-100)**：过低会失去激情

#### 数值变化规则
```javascript
// 积极互动
关心体贴的话 -> 好感+2~5, 信任+1~3, 无聊-1~2
幽默有趣话题 -> 好感+1~3, 新鲜感+2~5, 无聊-2~3
浪漫表达(≥暧昧阶段) -> 好感+3~5, 亲密+2~4

// 消极互动  
冷淡回应 -> 好感-2~5, 信任-1~3, 无聊+2~3
粗鲁无礼 -> 好感-5~10, 信任-3~5
重复无聊内容 -> 无聊+3~5, 新鲜感-2~5
```

### 4. 情绪系统

AI 会根据对话内容表现不同情绪：
- `happy` - 开心愉悦
- `shy` - 害羞腼腆  
- `angry` - 生气不满
- `sad` - 难过伤心
- `normal` - 平静正常
- `excited` - 兴奋激动
- `nervous` - 紧张不安

## 高级配置

### 模型选择

不同模型的特点：

| 模型 | 速度 | 质量 | 成本 | 适用场景 |
|------|------|------|------|----------|
| qwen-turbo | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ¥0.3/万tokens | 高并发、快速响应 |
| qwen-plus | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ¥2/万tokens | 推荐使用，平衡性好 |
| qwen-max | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ¥40/万tokens | 追求最佳效果 |

**推荐配置：**
- 开发测试：qwen-turbo（省钱）
- 生产环境：qwen-plus（推荐，Qwen3.5-Flash）
- 高端体验：qwen-max（最佳效果）

### 调整 AI 参数

修改 `chat-engine/index.js` 中的参数：

```javascript
parameters: {
  result_format: 'message',
  temperature: 0.8,      // 创造性（0.7-0.9）
  top_p: 0.8,            // 多样性（0.7-0.9）
  max_tokens: 500,       // 最大回复长度
  enable_search: false   // 是否联网搜索
}
```

**参数说明：**
- `temperature`: 越高越有创意，越低越稳定（推荐 0.8）
- `top_p`: 控制回复多样性（推荐 0.8）
- `max_tokens`: 回复字数限制（500 ≈ 300中文字）

### 优化对话质量

#### 1. 完善角色设定

```json
{
  "personality": "温柔体贴，善解人意，喜欢照顾人。但也有点小任性，偶尔会撒娇。",
  "speaking_style": "温和柔软，多用'呢'、'哦'、'～'等语气词。关系亲密后会用叠词。",
  "hobbies": ["阅读", "烘焙", "钢琴", "插花"],
  "background": "中文系研三学生，喜欢在图书馆度过安静的下午。从小学习钢琴，性格温柔恬静。"
}
```

#### 2. 添加更多关键词

在 `extractPersonalityKeywords` 函数中添加自定义关键词：

```javascript
const keywordMap = {
  '温柔': ['温柔', '体贴', '柔和', '温暖'],
  // 添加你的关键词
  '腹黑': ['腹黑', '狡猾', '小恶魔'],
  // ...
}
```

#### 3. 定制回复风格

修改 `buildSystemPrompt` 中的提示词，添加更多细节指导。

## 常见问题

### Q1: API 调用失败怎么办？

**检查步骤：**
1. 确认 API Key 是否正确
2. 查看账号余额是否充足
3. 检查网络连接
4. 查看云函数日志

**解决方案：**
- 系统会自动降级到模拟模式，不影响使用
- 修复 API 配置后会自动恢复真实 AI

### Q2: AI 回复不够自然？

**优化建议：**
1. 增加角色背景故事的细节
2. 在 `speaking_style` 中详细描述语气
3. 提高 `temperature` 参数（如 0.85）
4. 使用更高级的模型（qwen-max）

### Q3: AI 不记得之前的对话？

**检查要点：**
1. 确认 `recentMessages` 参数是否正确传入
2. 检查对话历史是否保存到数据库
3. 查看控制台是否有错误日志

### Q4: 性格表现不明显？

**改进方法：**
1. 在 `personality` 中使用更明确的关键词
2. 添加详细的 `speaking_style` 描述
3. 在 System Prompt 中增加性格示例
4. 多轮对话后性格会更明显

### Q5: 成本太高怎么办？

**省钱技巧：**
1. 使用 qwen-turbo 模型
2. 减少 `max_tokens` 限制
3. 减少对话历史数量（改为 5 轮）
4. 开发测试时使用模拟模式

### Q6: 如何切换回模拟模式？

删除或注释掉环境变量：
```bash
# DASHSCOPE_API_KEY=sk-xxxxx
```

上传云函数后，系统会自动使用本地模拟模式。

## 性能监控

### 查看调用情况

在阿里云控制台：
1. 进入 DashScope 控制台
2. 查看"用量统计"
3. 监控 tokens 消耗和费用

### 估算成本

```
单次对话 Token 消耗：
- System Prompt: ~800 tokens
- 对话历史(10轮): ~500 tokens  
- 用户消息: ~50 tokens
- AI回复: ~150 tokens
总计: ~1500 tokens/次

使用 qwen-plus (¥2/万tokens):
成本 = 1500 / 10000 × 2 = ¥0.003/次
1000次对话 ≈ ¥3
```

## 技术支持

- 阿里云文档：https://help.aliyun.com/zh/dashscope/
- Qwen模型介绍：https://help.aliyun.com/zh/dashscope/developer-reference/model-introduction
- 项目讨论：提交 Issue 到 GitHub 仓库

## 更新计划

- [ ] 支持语音对话
- [ ] 添加图片理解能力
- [ ] 实现多角色群聊
- [ ] 优化对话摘要功能
- [ ] 添加情感分析可视化

---

祝你的 AI 恋爱游戏开发顺利！🎮💕
